<!DOCTYPE html>
<html lang="cn">


<head>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>靈咖&gt;写下你的故事</title>

	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="../../css/a.css">
	<link rel="stylesheet" type="text/css" href="../../css/input.css">
	<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
	<!-- <link rel="stylesheet" type="text/css" href="../../css/all.min.css"> -->
	<!-- 1. 引入 jQuery（editor.md 核心依赖） -->
	<script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>

	<!-- 2. 引入 editor.md 核心样式 -->
	<link rel="stylesheet" href="/script/editor.md/css/editormd.css">

	<!-- 可选：代码高亮主题（editor.md 内置） -->
	<!-- <link rel="stylesheet" href="/script/editor.md/css/github.min.css"> -->
	<link rel="stylesheet" href="css/edit_md.css">


</head>

<body>
	<div id="header-container" style="height: 100vh;">
		<div class="title_menu box_bg_title">加载中</div>
	</div>

	<div class="main_border ">

		<div class="main_side_l" style="flex: 2;">
			<div class="side_l box_bg">
				<div class="list_box_side box_bg" id="contents_page" style="height: auto;"><a href="javascript:;"
						onclick="resetWatch()">开关一下实时预览以刷新显示</a></div>
			</div>
		</div>

		<div class="main_page_edit box_bg" id="main_view">
			<div class="main_page_for_side_r" style="width: 90%;height: 0;"></div>
			<div class="main_page_for_side_l" style="width: 100%;height: 0;"></div>
			<div id="md-editor-textarea">
				<textarea id="inp-content" style="display:none;">[TOC]
# 在这里写下你的故事喵
## 喵喵喵
</textarea>
			</div>
			<div class="box_bg" style="width: 100%;padding: 16px;">
				<div class="text_input">
					<label>*标题:</label><input type="text" id="title_in" name="username" placeholder="请输入" required>
				</div>
				<div class="text_input">
					<label>副标题:</label><input type="text" id="subtitle_in" name="username" placeholder="请输入">
				</div>
				<div class="text_input">
					<label>*标签:</label><input type="text" id="tag_in" name="username" placeholder="请输入">
				</div>
				<a href="javascript:;" onclick="show_color_input()"><i class="fa fa-gear"></i></a>
				<div class="more_set" style="width: 100%;display: none;">
					<div class="text_input color_input">
						<label>背景颜色:</label><input type="color" id="bg_color_in" name="username" value="#ffffff">
						<label>透明度:</label><input type="number" id="bg_tran_in" name="username" value=0.8 min="0"
							max="1" placeholder="请输入">
						<a href="javascript:;" onclick="reset_color()">重置</a>
					</div>
				</div>
			</div>
		</div>

		<div class="main_side_r">
			<div class="side_r">

			</div>
		</div>
	</div>




</body>

<script src="/script/editor.md/editormd.js"></script>

<script src="./script/header_loader.js"></script>
<script src="../../script/bg-js.js"></script>

<script src="./script/header_auto.js"></script>
<script src="./script/IDBUtil.js"></script>


<script>
	main_side_l.style.display = 'none';
	main_side_r.style.display = 'none';
	document.addEventListener('headerLoaded', () => {
		document.getElementById('to_edit_page').style.display = 'none';
		window.head_page.is_l_side_show = false;
		window.head_page.is_r_side_show = false;
		window.scroll(0, 0)
	});

	sourceEl.addEventListener('scroll', function () {
		// 1. 计算源元素的滚动比例（相对滚动高度）
		// scrollTop：已滚动的垂直距离
		// scrollHeight：元素内容的总高度（包括不可见部分）
		// clientHeight：元素可视区域的高度
		const scrollRatio = this.scrollTop / (this.scrollHeight - this.clientHeight);

		// 2. 根据比例计算目标元素应滚动的距离（单向同步核心）
		// 避免除以0（当内容高度≤可视高度时，scrollRatio为0）
		const targetScrollTop = scrollRatio * (targetEl.scrollHeight - targetEl.clientHeight) || 0;

		// 3. 设置目标元素的滚动位置（实现同步）
		targetEl.scrollTop = targetScrollTop;
	});
</script>

<!-- <script>
	const color_input = document.querySelector('.color_input');
	let is_show_color_input = false;
	const bg_color_in = document.getElementById('bg_color_in');
	const bg_tran_in = document.getElementById('bg_tran_in');
	const boxElements = document.querySelectorAll('.box_bg');
	const MAX_SATURATION = 0.2

	// 2. 监听颜色选择器的change事件（颜色改变时触发）
	bg_color_in.addEventListener('change', change_box_bg);
	bg_tran_in.addEventListener('change', change_box_bg);

	function show_color_input() {
		is_show_color_input = !is_show_color_input
		if(is_show_color_input){
			color_input.style.display = "";
		}else{
			color_input.style.display = "none";
		}
	}

	function change_box_bg() {
		const hexColor = bg_color_in.value; // 获取十六进制颜色（如#ff0000）
		const opacity = bg_tran_in.value;
		const rgb = hexToRgb(hexColor); // 转成RGB数值

		// 1. 判断是否是白色/黑色（豁免饱和度检查）
		const isWhite = hexColor === '#ffffff' || hexColor === '#fff';
		const isBlack = hexColor === '#000000' || hexColor === '#000';

		let finalRgb;
		if (isWhite || isBlack) {
			// 白/黑直接使用
			finalRgb = hexToRgb(hexColor);
		} else {
			// 2. 非白/黑：转HSV判断饱和度
			const rgb = hexToRgb(hexColor);
			const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);

			if (hsv.s > MAX_SATURATION) {
				// 饱和度超标：提示+自动降低饱和度到阈值
				// saturationTip.style.display = 'block';
				// 降饱和后转回RGB
				console.log("饱和度超标");

				finalRgb = hsvToRgb(hsv.h, MAX_SATURATION, hsv.v);
			} else {
				// 饱和度合规：直接使用
				finalRgb = rgb;
			}
		}

		// 3. 为每个box_bg设置带固定透明度的背景色
		boxElements.forEach(box => {
			box.style.backgroundColor = `rgba(${finalRgb.r}, ${finalRgb.g}, ${finalRgb.b}, ${opacity})`;

			// 文字颜色自动切换（基于最终颜色的深浅）
			const finalHex = rgbToHex(finalRgb.r, finalRgb.g, finalRgb.b);
			bg_color_in.value = finalHex;
			box.style.color = isDarkColor(finalHex) ? '#fff' : '#000';
		});
	}

	// 工具函数1：十六进制转RGB（兼容简写）
	function hexToRgb(hex) {
		const fullHex = hex.length === 4
			? `#${hex[1]}${hex[1]}${hex[2]}${hex[2]}${hex[3]}${hex[3]}`
			: hex;
		return {
			r: parseInt(fullHex.slice(1, 3), 16),
			g: parseInt(fullHex.slice(3, 5), 16),
			b: parseInt(fullHex.slice(5, 7), 16)
		};
	}

	// 工具函数2：RGB转HSV（核心：计算饱和度）
	function rgbToHsv(r, g, b) {
		r /= 255; g /= 255; b /= 255;
		const max = Math.max(r, g, b);
		const min = Math.min(r, g, b);
		let h = 0, s = 0, v = max;

		const d = max - min;
		s = max === 0 ? 0 : d / max;

		if (max !== min) {
			switch (max) {
				case r: h = (g - b) / d + (g < b ? 6 : 0); break;
				case g: h = (b - r) / d + 2; break;
				case b: h = (r - g) / d + 4; break;
			}
			h /= 6;
		}
		return { h, s, v };
	}

	// 工具函数3：HSV转RGB（用于降饱和后转回）
	function hsvToRgb(h, s, v) {
		let r, g, b;
		const i = Math.floor(h * 6);
		const f = h * 6 - i;
		const p = v * (1 - s);
		const q = v * (1 - f * s);
		const t = v * (1 - (1 - f) * s);

		switch (i % 6) {
			case 0: r = v; g = t; b = p; break;
			case 1: r = q; g = v; b = p; break;
			case 2: r = p; g = v; b = t; break;
			case 3: r = p; g = q; b = v; break;
			case 4: r = t; g = p; b = v; break;
			case 5: r = v; g = p; b = q; break;
		}
		return {
			r: Math.round(r * 255),
			g: Math.round(g * 255),
			b: Math.round(b * 255)
		};
	}

	// 工具函数4：RGB转十六进制（用于文字颜色判断）
	function rgbToHex(r, g, b) {
		return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
	}

	// 工具函数5：判断颜色深浅（用于文字切换）
	function isDarkColor(hexColor) {
		const rgb = hexToRgb(hexColor);
		const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
		return brightness < 128;
	}

	function reset_color() {
		bg_color_in.value = "#ffffff";
		bg_tran_in.value = 0.8;
		change_box_bg();
	}
</script> -->

<script src="./script/bg_color_s.js"></script>

<script>
	$(function () {
		let is_synch_scrol = true;
		let is_show_p_bg = true;
		let editor = editormd("md-editor-textarea", {
			path: "/script/editor.md/lib/",
			width: "100%",
			height: "95vh",
			delay: 500,
			htmlDecode: "style,script,iframe,object,embed|on*|javascript,base64,data:",
			codeFold: true,
			// autoHeight: true,

			saveHTMLToTextarea: true,
			watch: false,
			toolbarAutoFixed: false,

			toc: true,           // Table of contents
			tocm: true,


			emoji: true,
			taskList: true,
			tex: true,                   // 开启科学公式TeX语言支持，默认关闭
			flowChart: true,             // 开启流程图支持，默认关闭
			sequenceDiagram: true,       // 开启时序/序列图支持，默认关闭,

			editorTheme: editormd.editorThemes['theme-name'],

			// width: "100%",
			// height: "100%",
			// markdown: "xxxx",     // dynamic set Markdown text
			// path : "editor.md/lib/"  // Autoload modules mode, codemirror, marked... dependents libs path
			onload: function () {
				resetWatch();
			},
			toolbarIcons: function () {
				return [
					"undo", "redo", "|",
					"bold", "del", "italic", "quote", "|",
					"h1", "h2", "h3", "|",
					"centerIcon", "rightIcon", "|",
					"list-ul", "list-ol", "hr", "|",
					"link", "reference-link", "image", "code", "preformatted-text", "code-block", "table", "datetime", "emoji", "html-entities", "pagebreak", "|",
					"goto-line", "watch", "preview", "search", "|",
					"help", "|", "synch_scrol", "l_side_c", "show_title", "|", "save_local", "read_local"]
			},
			//如果没有图标，可以文字表述toolbarIconTexts:{ leftIcon:"left",},
			toolbarIconsClass: {
				centerIcon: "fa-align-center",
				rightIcon: "fa-align-right",
				synch_scrol: "fa-text-height",
				l_side_c: "fa-list-alt",
				show_title: "fa-chevron-circle-up",
				save_local: "fa-save",
				read_local: "fa-download",
			},
			// 自定义工具栏按钮的事件处理
			toolbarHandlers: {
				centerIcon: function (cm, icon, cursor, selection) {
					cm.replaceSelection("<p align='center'>" + selection + "</p>");
					if (selection === "") {
						cm.setCursor(cursor.line, cursor.ch + 18);
					}
				},
				rightIcon: function (cm, icon, cursor, selection) {
					cm.replaceSelection("<p align='right'>" + selection + "</p>");
					if (selection === "") {
						cm.setCursor(cursor.line, cursor.ch + 17);
					}
				},
				synch_scrol: function (cm, icon, cursor, selection) {
					is_synch_scrol = !is_synch_scrol
					editor.config("syncScrolling", is_synch_scrol);
				},
				l_side_c: function (params) {
					window.head_page.is_l_side_show = !window.head_page.is_l_side_show;
					if (window.head_page.is_l_side_show) {
						editor.config("tocContainer", "#contents_page");
						main_side_l.style.display = '';
						main_page_for_side_l.style.display = '';
						resetWatch();
					} else {
						editor.config("tocContainer", "");
						main_side_l.style.display = 'none';
						main_page_for_side_l.style.display = 'none';
						resetWatch();
					}
				},
				show_title: function (params) {
					try {
						window.head_page.is_show_title = !window.head_page.is_show_title
						if (window.head_page.is_show_title) {
							document.querySelector('.title_menu').style.display = "";
							document.querySelector('.title_menu_bottom').style.height = window.head_page.title_h;
						} else {
							document.querySelector('.title_menu').style.display = "none";
							document.querySelector('.title_menu_bottom').style.height = "0px";
						}
					} catch (error) {
						console.log(error);
					}
				},

				save_local: function (params) {
					IDBUtil.saveObjectToIDB(
						'page_data',
						'UserStore',
						'edit',
						save_page_data()
					).then((saveResult) => {
						console.log("保存成功");
					}).catch((e) => {
						console.error(e);
					});
				},
				read_local: function (params) {
					IDBUtil.getObjectFromIDB(
						'page_data',
						'UserStore',
						'edit'
					).then((readResult) => {
						set_page_data(readResult)
						// editor.setMarkdown(readResult);
					}).catch((e) => {
						console.error(e);
					});
				},
			},
			lang: {
				toolbar: {
					leftIcon: "居左",
					centerIcon: "居中",
					rightIcon: "居右",
					synch_scrol: "同步滚动",
					l_side_c: "悬挂目录",
					show_title: "隐藏标题",
					save_local: "本地保存(仅保存一份)",
					read_local: "读取保存",
				}
			},
		});
		function resetWatch() {
			// testEditormd.setCursor({line:0, ch:0});
			// editor.insertValue(" ");
			// editor.focus();
			editor.config("watch", false);
			setTimeout(() => {
				editor.config("watch", true);
			}, 700);
		}

		function save_page_data() {

			const pdata = {
				markdow: editor.getMarkdown(),
				title: document.getElementById('title_in').value,
				subtitle: document.getElementById('subtitle_in').value,
				tag: document.getElementById('tag_in').value,
				bg_color: bg_color_in.value,
				bg_tran: bg_tran_in.value,
				date: Date.now(),
				author: "默认",
			}
			return pdata;
		}

		function set_page_data(pdata) {
			try {
				editor.setMarkdown(pdata["markdow"]);
				document.getElementById('title_in').value = pdata["title"];
				document.getElementById('subtitle_in').value = pdata["subtitle"];
				document.getElementById('tag_in').value = pdata['tag'];
				bg_color_in.value = pdata["bg_color"];
				bg_tran_in.value = pdata["bg_tran"];
				change_box_bg();
			} catch (error) {
				console.error(error);
			}

		}

	});
</script>


</html>